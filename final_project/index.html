<!DOCTYPE html>
<html>
<head> 
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Final Project - Daniele Conti</title> 
  <style>
    body{
      margin: 0;
      overflow: hidden;
    }

    #stats {  /* Align stats top-left */
      position: absolute;
      left: 0px;
      top: 0px;
    }
    /*roba aggiunta da me*/
    #pointer {
     position: fixed;
     top: 50%;
     left: 50%;
     margin-top: -15px;
     margin-left: -15px;
     width: 30px;
     height: 30px;
     display: none;
     background-image: url("images/pointer.png");
     background-repeat: no-repeat;
     background-size: contain;
   }

   #film{
    display: none; 
    position: absolute; 
    left: 0px;
    top: 0px;
  }
  #monitor{
    display: none; 
    position: absolute; 
    left: 0px;
    top: 0px;
  }
  #videoImage{
    display: none; 
    position: absolute; 
    left: 0px;
    top: 0px;
  }

  /**/
</style> 
</head>
<body>

  <!-- Roba per la webcam -->
  <video id="monitor" autoplay width="160" height="120" style="visibility: hidden; float:left;"></video>
  <canvas id="videoImage" width="160" height="120" style="visibility: hidden; float:left;"></canvas>
  <video id="film" src="movies/Big_Buck_Bunny_small.ogv" controls="true" autoplay="false"></video> 
  <script>
    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
    window.URL = window.URL || window.webkitURL;

    var camvideo = document.getElementById('monitor');

    if (!navigator.getUserMedia) 
    {
      document.getElementById('errorMessage').innerHTML = 
      'Sorry. <code>navigator.getUserMedia()</code> is not available.';
    } else {
      navigator.getUserMedia({video: true}, gotStream, noStream);
    }

    function gotStream(stream) 
    {
      if (window.URL) 
        {   camvideo.src = window.URL.createObjectURL(stream);   } 
  else // Opera
    {   camvideo.src = stream;   }

  camvideo.onerror = function(e) 
  {   stream.stop();   };

  stream.onended = noStream;
}

function noStream(e) 
{
  var msg = 'No camera available.';
  if (e.code == 1) 
    {   msg = 'User denied access to use camera.';   }
  // document.getElementById('errorMessage').textContent = msg;
}
</script>

<!--  roba aggiunta da me -->
<div id="pointer"></div>
<!--  -->

<!-- JavaScript libraries -->
<script src="libs/three.min.js"></script>
<script src="libs/jquery.min.js"></script>  
<script src="libs/tween.min.js"></script>
<script src="libs/PointerLockControls.js"></script>
<script src="libs/Stats.min.js"></script>
<script src="libs/dat.gui.min.js"></script>
<script src="libs/TrackballControls.js"></script>
<script type="text/javascript" src="libs/OBJLoader.js"></script> 
<script type="text/javascript" src="libs/MTLLoader.js"></script> 
<script type="text/javascript" src="libs/OBJMTLLoader.js"></script> 

<script src="scripts/initVideo.js"></script>
<script src="scripts/functions.js"></script>
<script src="scripts/forniture.js"></script>
<script src="scripts/rooms.js"></script>
<script src="scripts/fpsInteract.js"></script>


<script src="scripts/init.js"></script>
<script src="scripts/SpecialFX.js"></script>
<script src="scripts/apartment.js"></script>
<script src="scripts/light.js"></script>
<script src="scripts/decoration.js"></script>


<script src="scripts/gui.js"></script>


<!-- Javascript code that runs our Three.js examples --> 
<script>
    // once everything is loaded, we run our Three.js stuff.
    $(function () {

      // add the output of the renderer to the html element
      $('body').append(webGLRenderer.domElement);


      
      // Per la Collision detection pongo tutti gli oggetti in un array
      apartment.traverse(function (child) {
        if (child instanceof THREE.Mesh) {
          objects.push(child);
        }
      });


      render();

      function render() {
        stats.update();
        TWEEN.update();
        trackballControls.update();
        requestAnimationFrame(render);
        webGLRenderer.render(scene, camera);

        // Pioggia
        if(rain){
          var vertices = particleSystem.geometry.vertices;
          vertices.forEach(function (v) {
            v.y = v.y - (v.velocityY);
            v.x = v.x - (v.velocityX);

            if (v.y <= 0) v.y = 500;
            if (v.x <= -20 || v.x >= 20) v.velocityX = v.velocityX * -1;
          });
        }

        if(shower.grip.on){
          var gocce = streamShower.geometry.vertices;
          // console.log(gocce);
          gocce.forEach(function(v){
          v.z = v.z - (v.velocityZ);
          if(v.z <=0) v.z = 3.3;

          // console.log(v.z);

          });
        }


        if (FPenabled === true) {
          computeFPControls();
          if(collisione) {detectCollision();}
        }
        // **** Controllo WebCam ****
        if ( video.readyState === video.HAVE_ENOUGH_DATA ) 
        {
          videoImageContext.drawImage( video, 0, 0, videoImage.width, videoImage.height );
          if ( videoTexture ) 
            videoTexture.needsUpdate = true;
        }

        // ******* Controllo video TV *********
        if (film.readyState === film.HAVE_ENOUGH_DATA) {
          if (isOn) {
            if (textureSW) textureSW.needsUpdate = true;
            film.play();
          } else {
           film.pause();
         }
       }
     }
   });
</script>  
</body>
</html>